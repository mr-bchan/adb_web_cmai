<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <!-- <link rel="stylesheet" type="text/css" href="css/style.css"> -->
    <link rel="stylesheet" type="text/css" href="css/tree.css">
    <link rel="stylesheet" type="text/css" href="css/chat.css">
    <title>Neural Mechanics - Tree</title>
</head>

<body>
    <header class="header d-flex justify-content-between align-items-center mb-4">
        <div class="logo">
            <img src="images/logo.png">
        </div>
        <div class="btn-menu">
            <button class="btn btn-primary" id="close-window">Close</button>
            <button class="btn btn-primary">Save</button>
            <button class="btn btn-primary" id="export-window">Generate Document</button>
        </div>
    </header>
    <section class="container-fluid">
        <div class="row">
            <div class="col">
                <div class="card cause">
                    <div class="card-header cause" id="cause-line">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Cause</span>
                            <button data-title="Add Cause" data-group="cause" class="btn-add"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item asd">
                            <span class="data-view" data-group="cause" data-value="road transport for moving freight">road transport for moving freight</span>
                            <span class="float-right">
                                <button class="btn-edit">
                                    <i class="fas fa-pencil-alt"></i>
                                </button> 
                                <button class="btn-delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </span>
                        </li>
                        <!--<li class="list-group-item asd">
                            <span class="data-view" data-group="cause" data-value="test 2">test 2</span>
                            <span class="float-right">
                                <button class="btn-edit">
                                    <i class="fas fa-pencil-alt"></i>
                                </button> 
                                <button class="btn-delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </span>
                        </li>
                        <li class="list-group-item asd">
                            <span class="data-view" data-group="cause" data-value="test 3">test 3</span>
                            <span class="float-right">
                                <button class="btn-edit">
                                    <i class="fas fa-pencil-alt"></i>
                                </button> 
                                <button class="btn-delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </span>
                        </li>-->
                    </ul>
                </div>
            </div>
            
            <div class="col">
                <div class="card problem">
                    <div class="card-header problem">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Problem</span>
                            <button data-title="Add Problem" data-group="problem" class="btn-add"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <ul class="list-group list-group-flush child">
                        <li class="list-group-item cause-line" id=problem1>
                            <span class="data-view" data-group="problem" data-value="rapidly growing emissions">rapidly growing emissions</span>
                            <span class="float-right">
                                <button class="btn-edit">
                                    <i class="fas fa-pencil-alt"></i>
                                </button> 
                                <button class="btn-delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </span>
                        </li>
                        <!--<li class="list-group-item cause-line" id=problem2>
                            <span class="data-view" data-group="problem" data-value="test 3">test 3</span>
                            <span class="float-right">
                                <button class="btn-edit">
                                    <i class="fas fa-pencil-alt"></i>
                                </button> 
                                <button class="btn-delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </span>
                        </li>-->
                    </ul>
                </div>
            </div>
            <div class="col">
                <div class="card effect">
                    <div class="card-header effect problem1 problem2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Effect</span>
                            <button data-title="Add Effect" data-group="effect" class="btn-add"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <span class="data-view" data-group="effect" data-value="global climate change">global climate change</span>
                            <span class="float-right">
                                <button class="btn-edit">
                                    <i class="fas fa-pencil-alt"></i>
                                </button> 
                                <button class="btn-delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </span>
                        </li>
                        <li class="list-group-item">
                            <span class="data-view" data-group="effect" data-value="local air pollution">local air pollution</span>
                            <span class="float-right">
                                <button class="btn-edit">
                                    <i class="fas fa-pencil-alt"></i>
                                </button> 
                                <button class="btn-delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>
    <footer></footer>
    <div class="add-modal modal fade show" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button> -->
                </div>
                <div class="modal-body">
                    <!-- <p>Modal body text goes here.</p> -->
                    <form>
                        <input type="text" class="form-control" name="text" data-group="">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Create</button>
                </div>
            </div>
        </div>
    </div>
    <div class="edit-modal modal fade show" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="text-transform: capitalize;">Modal title</h5>
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button> -->
                </div>
                <div class="modal-body">
                    <!-- <p>Modal body text goes here.</p> -->
                    <form>
                        <input type="text" class="form-control" name="text" data-group="">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Update</button>
                </div>
            </div>
        </div>
    </div>
    <div class="chat-div">
        <div class="chat-box-wrapper">
            <div class="chat-box">
                <div class="chat-header text-center">Chat</div>
                <div class="chat-convo">
                    <div class="sender-wrapper">
                        <div class="sender d-flex justify-content-start">
                            <div class="sender-img-wrapper"><img src="images/bee.png"></div>
                            <div class="sender-msg-wrapper">
                                <div class="sender-msg">
                                    <div class="sender-name">AidBee</div>
                                    <div class="sender-content">Hi! I'm AidBee, your personal assistant <br> just a buzz away! <br> How may I help you?</div>
                                </div>
                                <div class="time-sent">
                                    4:30 PM
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="receiver">
                            <div class="receiver-msg-wrapper d-flex justify-content-end">
                                <div class="receiver-msg">Hello</div>
                                <i class="invisible align-self-end sent fas fa-check-circle"></i>
                            </div>
                            <div class="d-none time-sent">
                                4:30 PM
                            </div>
                    </div>
                    <div class="receiver">
                            <div class="receiver-msg-wrapper d-flex justify-content-end">
                                <div class="receiver-msg">Can I see the top keywords <br> for this topic?</div><i class="align-self-end sent fas fa-check-circle"></i>
                            </div>
                            <div class="time-sent">
                                4:30 PM
                            </div>
                    </div>
                                    <div class="sender-wrapper">
                        <div class="sender d-flex justify-content-start">
                            <div class="sender-img-wrapper"><img src="images/bee.png"></div>
                            <div class="sender-msg-wrapper">
                                <div class="sender-msg">
    <!--                                 <div class="sender-name">Customer Service</div>
                                    <div class="sender-content">Welcome to ADB <br> How may I help you</div> -->
                                    <div class="ticontainer">
                                      <div class="tiblock">
                                        <div class="tidot"></div>
                                        <div class="tidot"></div>
                                        <div class="tidot"></div>
                                      </div>
                                    </div>
                                </div>
                                <div class="d-none time-sent">
                                    4:30 PM
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="receiver">
                        <div class="receiver-msg-wrapper d-flex justify-content-end">
                            <div class="receiver-msg">
                                <div class="ticontainer">
                                  <div class="tiblock">
                                    <div class="tidot"></div>
                                    <div class="tidot"></div>
                                    <div class="tidot"></div>
                                  </div>
                                </div>
                            </div><i class="d-none align-self-end sent fas fa-check-circle"></i>
                        </div>
                        <div class="d-none time-sent">
                            4:30 PM
                        </div>
                    </div>
                </div>
                <form id="chat-form" class="d-flex justify-content-start">
                    <!-- <input type="text" name="message" placeholder="Write a Message..."> -->
                    <textarea name="message" placeholder="Write a Message..."></textarea>
                    <button onclick="return false;">
                        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                             width="61.25px" height="61.25px" viewBox="0 0 61.25 61.25" enable-background="new 0 0 61.25 61.25" xml:space="preserve">
                            <path fill="#B3BEC6" d="M31.708,31.348L7.363,33.705L0.955,54.196c-0.528,1.672,0.399,3.456,2.072,3.984
                                c0.777,0.247,1.619,0.183,2.351-0.176l53.358-25.836c1.507-0.735,2.134-2.553,1.399-4.06c-0.297-0.609-0.79-1.101-1.399-1.398
                                L5.416,0.855C3.84,0.084,1.938,0.737,1.168,2.313C0.81,3.045,0.747,3.887,0.992,4.665L7.4,25.155l24.299,2.356
                                c1.055,0.105,1.825,1.043,1.721,2.099c-0.09,0.91-0.81,1.63-1.721,1.72L31.708,31.348z"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
        <div class="text-right">
            <button class="btn-chat show">
                <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
     width="147.167px" height="149.167px" viewBox="0 0 147.167 149.167" enable-background="new 0 0 147.167 149.167"
     xml:space="preserve">
                    <title>1</title>
                    <path fill="#FFFFFF" d="M122.578,1H24.422C11.763,1,1.5,11.457,1.5,24.369v65.987c0,0.486,0.02,0.964,0.048,1.443
                        c-0.03,0.234-0.046,0.473-0.048,0.709v49.635c0,3.156,1.654,3.806,3.676,1.406l25.237-29.768h92.166
                        c12.655,0,22.922-10.51,22.922-23.425V24.369C145.5,11.457,135.236,1,122.578,1z"/>
                </svg>
            </button>
            <button class="btn-chat hide">
                <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
     width="180px" height="180px" viewBox="0 0 180 180" enable-background="new 0 0 180 180" xml:space="preserve">
                    <g id="Close">
                        <path fill="#FFFFFF" d="M111.393,90l64.178-64.177c5.907-5.907,5.907-15.485,0-21.392c-5.908-5.908-15.485-5.908-21.393,0
                            L90,68.608L25.822,4.43c-5.907-5.908-15.484-5.908-21.392,0c-5.907,5.908-5.907,15.486,0,21.392l64.178,64.177L4.43,154.177
                            c-5.907,5.907-5.907,15.485,0,21.392c5.908,5.908,15.485,5.908,21.392,0L90,111.392l64.178,64.177
                            c5.906,5.908,15.484,5.908,21.393,0c5.907-5.907,5.907-15.484,0-21.392L111.393,90z"/>
                    </g>
                </svg>
            </button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <!--     <script src="js/jQuery-v1.11.1.js"></script>
 -->
    <script src="js/jquery.connections.js"></script>
    <script src="js/bezier.js"></script>
    <script type="text/javascript" src="js/chat.js"></script>
    <script type="text/javascript" src="js/update_tree.js"></script>
    <script type="text/javascript">
    $(document).ready(function($) {
        var addModal = $('.add-modal');
        // on add event
        $('.btn-add').on('click', function(event) {
            event.preventDefault();
            addModal.modal('show');
            var title = $(this).attr('data-title');
            var dataGroup = $(this).attr('data-group');
            addModal.find('.modal-title').text(title);
            addModal.find('input[name=text]').attr('data-group', dataGroup);
        });

        // modal on shown
        addModal.on('shown.bs.modal', function() {
            $(this).find('input[name=text]').focus();
        });

        // add modal on hidden
        addModal.on('hidden.bs.modal', function() {
            $(this).find('.modal-title').text("");
            $(this).find('input[name=text]').attr('data-group', "");
            $(this).find('input[name=text]').val("");
        })

        // add modal click event 
        $('.add-modal .btn.btn-primary').on('click', function(event) {
            event.preventDefault();
            var input = $(this).closest('.add-modal').find('input[name=text]');
            var inputGroup = input.attr('data-group');
            var text = input.val();
            var inputGroupUl = $('.card.' + inputGroup + ' ul.list-group');

            if (text.trim().length <= 0) {
                alert("Please fill in required fields.");
                return;
            }

            input.val("");
            input.attr('data-group', "");
            addModal.modal('hide');

            var listCount = inputGroupUl.find("li").length+1;

            var liId = inputGroup+listCount;

            /*var html = '<li class="list-group-item" id="'+liId+'">' +
                '<span class="data-view" data-group="' + inputGroup + '" data-value="' + text + '">' + text + '</span>' +
                '<span class="float-right">' +
                '<button class="btn-edit"><i class="fas fa-pencil-alt"></i></button> ' +
                '<button class="btn-delete"><i class="fas fa-trash-alt"></i></button>' +
                '</span>' +
                '</li>';

            inputGroupUl.append(html);*/

            let newLi = $("<li></li>").addClass("list-group-item").attr({
                id: liId
            });

            let newSpan = $("<span></span>").addClass('data-view').attr({
                "data-group": inputGroup,
                "data-value": text,
            }).text(text);

            let newEditButton = $("<button></button>").addClass('btn-edit').append($("<i></i>").addClass('fas fa-pencil-alt'));
            let newDeleteButton = $("<button></button>").addClass('btn-delete').append($("<i></i>").addClass('fas fa-trash-alt'));
            let newSpanButton = $("<span></span>").addClass('float-right').append(newEditButton, " ",newDeleteButton);

            if (inputGroup == 'problem') {
                newLi.addClass("cause-line");
                $(".card-header.effect").addClass(liId);
            }
            
            newLi.append(newSpan, newSpanButton);

            inputGroupUl.append(newLi);
            drawLine()
        });

        $('.add-modal input[name="text"]').on('keypress', function(event) {
            // event.preventDefault();
            if (event.which == 13) {
                $('.add-modal .btn.btn-primary').trigger('click');
                event.preventDefault();
            }

        });

        $(document).on('click', 'button.btn-delete', function(event) {
            event.preventDefault();
            var selector = $(this);

            var liId = selector.closest('li').attr('id');

            $(".card-header.effect").removeClass(liId);

            selector.closest('li').remove();

            drawLine()
        });

        var editModal = $('.edit-modal');
        // on add event
        $(document).on('click', '.btn-edit', function(event) {
            event.preventDefault();
            editModal.modal('show');
            var dataGroup = $(this).closest('li').find('.data-view').attr('data-group');
            var text = $(this).closest('li').find('.data-view').attr('data-value');
            editModal.find('.modal-title').text('Edit ' + dataGroup);
            editModal.find('input[name=text]').attr('data-group', dataGroup);
            editModal.find('input[name=text]').val(text);
            editModal.find('input[name=text]').attr('data-index', $(this).closest('li').index());
            // console.log();
        });

        $('.edit-modal .btn.btn-primary').on('click', function(event) {
            event.preventDefault();
            var input = $(this).closest('.edit-modal').find('input[name=text]');
            var inputGroup = input.attr('data-group');
            var text = input.val();
            var index = input.attr('data-index');
            index = parseInt(index) + 1;
            var selector = '.card.' + inputGroup + ' ul li:nth-child(' + index + ') .data-view';
            $(selector).attr('data-value', text);
            $(selector).html(text);
            // console.log($(selector).html());
            editModal.modal('hide');
        });

        // modal on shown
        editModal.on('shown.bs.modal', function() {
            $(this).find('input[name=text]').focus();
        });

        $('.edit-modal input[name="text"]').on('keypress', function(event) {
            // event.preventDefault();
            if (event.which == 13) {
                $('.edit-modal .btn.btn-primary').trigger('click');
                event.preventDefault();
            }

        });

        $("#close-window").click(function(){
            window.close();
        });

        $("#export-window").click(function(){

            // Get values from user selections
            keyword = data['keyword']
            problems = $('.card.problem').find('li').map(function(){ return this.innerText }).get()
            causes = $('.card.cause').find('li').map(function(){ return this.innerText }).get()
            effects = $('.card.effect').find('li').map(function(){ return this.innerText }).get()

            console.log(problems)
            data = {
                'keyword':keyword,
                'phrases': problems.concat(causes).concat(effects),
            }

            sessionStorage.setItem('tree_data', JSON.stringify(data));
            window.open('ghost-writer.html','_blank');
        });

        function drawLine()
        {
            $("#ropebag").find("svg").remove();
            /*
             * Starting line is the element with your set id and connects to an element with the class of the set id
             */

            //draw line from cause header to problem lists
            $(".card-header.cause").bezier({ 
                strokeColor : '#686bf0',
                class: "test"
            });

            //draw line from problem lists to effect header
            //for this case we need to connect all the problem list to the effect header so we targeted the classes of the problem list and each li element has their own id and is set to the class of the effect header
            $(".cause-line").bezier({
                strokeColor : '#01cbcd',
            });
        }

        drawLine()

        /*
            Populate problem tree based on sessionStorage

             data = {
                'cause': <list of causes>,
                'problem': <list of problems>,
                'effect': <list of effects>,
                'keyword': <input of user from the searh page>
            }
        */
        data = sessionStorage.getItem('data');

        if(data){
             data = JSON.parse(data)
             update_problem_tree(data)
        }
        else{
            data = []
        }

    });
    </script>
</body>

</html>
